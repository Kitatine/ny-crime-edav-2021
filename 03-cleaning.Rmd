# Data transformation

Here we include the basic data transformation as the preprocessing module to clean the data and obtain some fundamental insights. Most of the data provided by NYPD has already been organized and has few missing data, so our focus here would mainly be insights formulation, where we shall decide the specific metric for further exploration.     
Notice that since all our data listed here have millions of rows, so we turn to the `ff` library to enable fast loading the dataset feature.   


```{r import the data}
library(ff)
library(dplyr)
library(ggplot2)
# if want to see the detailed output, add the VERBOSE = TRUE option for the read.csv.ffdf function
complaint.df = read.csv(file="data/NYPD_Complaint_Data_Historic.csv")
```
First we define some reusable module that we would repetitively use in our analysis below,   

```{r cleaning data analysis, reusable module}
filter_before <- function(df, col, format = "%m/%d/%Y", year = NULL, date = NULL, option = NULL) {
    if (option == 'y'){
      df[['Year']] <- format(as.Date(df[[col]], format=format),"%Y")
      return(df %>% filter(Year >= year))
    }
}
```

## Preprocessing for Arrest data
```{r load the data, arrest}
arrest.df = read.csv.ffdf(file = 'data/NYPD_Arrests_Data__Historic_.csv', header=TRUE, 
                  first.rows=10000, next.rows=50000)

arrest.df = as.data.frame(arrest.df)
str(arrest.df)
knitr::kable(head(arrest.df), caption = "Head 6 Rows in Arrest Dataset for Temporal Analysis",
             row.names = F,font_size = 10)
```

### Preprocessing for Time Analysis

```{r data transformation for arrest time analysis}

time_target <- function(df, time_id_col, option = NULL, col_of_interest = NULL, target_col  = NULL,
                        group_option = NULL){
    if (option == 'year') {
        df[['Year']] <- format(as.Date(df[[time_id_col]], format="%m/%d/%Y"),"%Y")
        if (!is.null(col_of_interest)) {
            df.interest <- df[col_of_interest]
            df.interest[df.interest==""] <- NA
            df.interest <- na.omit(df.interest)
            if(!is.null(group_option)){
              df_year_target = df.interest %>% group_by(Year, across(all_of(target_col))) %>% 
    summarise(count = n()) %>% mutate(prop = count/sum(count))
              return (df_year_target)
            }
            else{
              return(df.interest)
            }
            
        }
        else {
          return(df[['Year']])
        }
    }
    if (option == "month") {
      df[['Month']] <- format(as.Date(df[[time_id_col]], format="%m/%d/%Y"),"%m")
      if (!is.null(col_of_interest)) {
            df.interest <- df[col_of_interest]
            df.interest[df.interest==""] <- NA
            df.interest <- na.omit(df.interest)
            df_year_target = df.interest %>% group_by(Month, across(all_of(target_col))) %>% 
    summarise(count = n())
            return (df_year_target)
        }
        else {
          return(df[['Month']])
        }
    }
}
```

```{r}
df_year_target <- time_target(arrest.df, 
                        time_id_col = 'ARREST_DATE',
                        option = 'year',
                        col_of_interest = c('LAW_CAT_CD', 'ARREST_DATE', 'Year'),
                        target_col = 'LAW_CAT_CD',
                        group_option = 'group')
knitr::kable(head(df_year_target), caption = "Head 6 Rows in Arrest Dataset for Temporal Analysis",
             row.names = F,font_size = 10)
```


### Preprocessing for Spatial Anaylsis

```{r}
df_year <- time_target(arrest.df, 
                        time_id_col = 'ARREST_DATE',
                        option = 'year',
                        col_of_interest = c('LAW_CAT_CD', 'ARREST_DATE', 'Year', 'ARREST_BORO',
                                            'Latitude', 'Longitude'),
                        target_col = 'LAW_CAT_CD')
knitr::kable(head(df_year), caption = "Head 6 Rows in Arrest Dataset for Spatial Analysis",
             row.names = F,font_size = 10)
```

