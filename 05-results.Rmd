# Results

```{r echo = FALSE, results = FALSE}
#all the code below are just tests, just trying to make things work , will be extracted later on
library(ff)

library(ggmap)
library(ggplot2)
library(tidyr)
library(highcharter)
library(leaflet)
library(lubridate)

library(rgdal)
library(httr)
library(dplyr)
library(sp)
library(tigris)
library(broom)

require("maptools")
library("gpclib")
gpclibPermit()

library('rjson')
library(ggpubr)

# color palettes
library(RColorBrewer)

# word cloud generator
library(wordcloud)
library(wordcloud2)

# for text mining
library(tm)

result <- fromJSON(file = 'configure.json')
GOOGLE_KEY <- result$GOOGLE_KEY
register_google(key = GOOGLE_KEY)
# ggmap version 2.7+ required, use devtools::install_github('dkahle/ggmap', dep=F)


```


## Crime Arrest Analysis

### Overall Illustration on Map

```{r}
library(leaflet)
library(ggmap)

df_year = df_year %>% mutate(lon = Longitude, lat = Latitude)
df_2020 = df_year %>% filter(Year == "2020")
leaflet(df_year, height=300, width=900) %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=df_2020$lon, lat=df_2020$lat,
             clusterOptions = markerClusterOptions())

```



### Time Analysis

We first perform some transformation on the arrest dataset to enable our illustration for the trend of the data.

Then we first could illustrate in the time line to see the trend of the overall incidents for each level of offense to see if there is any dramatic change in the pandameic year.   

```{r illustrate time trend for arrest, total count for offense}
options(scipen = 999)
df_year_target$LAW_CAT_CD <- factor(df_year_target$LAW_CAT_CD, levels = c("M", "F", "V", "I"))

year_range <- unique(df_year_target$Year)
caption = "Number of incidents of different offense level over"
caption <- paste(caption,
                 min(year_range), "-", max(year_range))

cols <- brewer.pal(n = 8, name = "Set2")
color_lst <- colorspace::rainbow_hcl(n = 4)

# the component is no more used
static_trend_plot_arrest <- function(df) {
  plt_arrest_1 <- 
    ggplot(data = df, aes(x = as.numeric(Year), y = count)) + 
      ggtitle(caption) + 
      xlab("Year") + 
      ylab("Number of incidents") + 
      geom_point(aes(color = LAW_CAT_CD), size = 1) + 
      geom_line(aes(color = LAW_CAT_CD), size = 1) +
      scale_color_manual(labels = c("Misdemeanor", "Felony", "Violation", "Other"), values = color_lst) +
      theme_bw() +
      guides(color = guide_legend("Levels of Offense"))
  
  return(plt_arrest_1)
}

# the component is in working
interactive_trend_plot_arrest <- function(df){
  levels(df$LAW_CAT_CD) <- c("Misdemeanor", "Felony", "Violation", "Other")
  plt <-
    df %>% 
      hchart(
        'line', hcaes(x = Year, y = count, group = LAW_CAT_CD)
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>", caption, "</b>")) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

# static_trend_plot_arrest(df_year_target)
interactive_trend_plot_arrest(df_year_target)
```

Also, we could investigate the ratio of each kind of offense by years by looking at the stacked bar plot,   

```{r interactive bar chart 1 for arrest data}
temporal_ratio_plot_arrest <- function(df) {
  levels(df$LAW_CAT_CD) <- c("Misdemeanor", "Felony", "Violation", "Other")
  plt <-
    df %>% 
      hchart(
        'column', hcaes(x = 'Year', y = 'count', group = 'LAW_CAT_CD'),
        stacking = 'normal'
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating = TRUE, y = 50) %>%
      hc_title(text = "<b>Ratio trend of different level of offense event</b>") %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense") 
  return(plt)
}
temporal_ratio_plot_arrest(df_year_target)
```

From the plot, we notice that though over the years since 2016 to 2020, the misdemeanor level of offense remains as the most frequently happened events, its ratio suffers a significant decrease. Moreover, we can witness the improvement in the safety of the community by noticing the fewer and fewer occupation of the violation class events.    



### Spatial Analysis   
Having some basic idea in temporal data, we could then zoom in to investigate the detailed spatial distibution of those offense incidents.  

daibiaoxing nianfen, zooming in dao diqu

```{r}
df_year$LAW_CAT_CD <- factor(df_year$LAW_CAT_CD, levels = c("M", "F", "V", "I"))

spatial_plot_arrest <- function(df, year){
  plt_arrest_3 <-
    ggplot(data = df %>% filter(Year == year), aes(x = ARREST_BORO)) + 
        geom_bar(aes(fill = LAW_CAT_CD)) + 
        scale_fill_manual(labels = c("Misdemeanor", "Felony", "Violation", "Other"), values = color_lst) +
        ggtitle(paste("The histogram of offense incidents by borough, Year", year)) + 
        xlab("Areas (Boroughs)") + 
        ylab("Number of offenses")  +
        theme(legend.position = "bottom") + 
        scale_x_discrete(labels = c('Bronx', 'Staten Island', 'Brooklyn', 'Manhattan', 'Queens')) +
        guides(fill = guide_legend("Levels of Offense"))
  return(plt_arrest_3)
}

spatial_plot_arrest_interactive <- function(df, year) {
  levels(df$LAW_CAT_CD) <- c("Misdemeanor", "Felony", "Violation", "Other")
  levels(df$ARREST_BORO) <- c('Bronx', 'Brooklyn', 'Manhattan', 'Queens', 'Staten Island', 'Other')
  plt <- 
    df %>% filter(Year == year) %>%
      hchart(
        'column', hcaes(x = 'ARREST_BORO', y = 'count', group = 'LAW_CAT_CD'),
        stacking = 'normal'
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>The histogram of offense incidents by borough, Year", year, '</b>')) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

df <- df_year %>% group_by(Year, LAW_CAT_CD, ARREST_BORO) %>% summarise(count = n()) 

spatial_plot_arrest_interactive(df, 2010)
spatial_plot_arrest_interactive(df, 2019)
spatial_plot_arrest_interactive(df, 2020)

# spatial_plot_arrest(df_year, 2010)
# spatial_plot_arrest(df_year, 2019)
# spatial_plot_arrest(df_year, 2020)

```





## Crime Complaint Analysis

### Time Analysis

```{r}
complaint.df_year_target$LAW_CAT_CD <- factor(complaint.df_year_target$LAW_CAT_CD)
year_range <- unique(complaint.df_year_target$Year)
caption = "Number of complained incidents of different offense level over"
caption <- paste(caption,
                 min(year_range), "-", max(year_range))

cols <- brewer.pal(n = 8, name = "Set2")
color_lst <- colorspace::rainbow_hcl(n = 4)

# the component is in working
interactive_trend_plot_complaint <- function(df){
  levels(df$LAW_CAT_CD) <- c("Felony", "Misdemeanor", "Violation")
  plt <-
    df %>% 
      hchart(
        'line', hcaes(x = Year, y = count, group = LAW_CAT_CD)
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>", caption, "</b>")) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

# static_trend_plot_arrest(df_year_target)
interactive_trend_plot_complaint(complaint.df_year_target)
```

```{r merge two summary table}

df_year_target$Type = c('Arrest')
complaint.df_year_target$Type = c('Complaint')
df_year_target <- df_year_target[df_year_target$LAW_CAT_CD != 'I', c('Type', 'Year', 'LAW_CAT_CD', 'count')]
df_year_target$LAW_CAT_CD <- droplevels(df_year_target$LAW_CAT_CD)
df_year_target$LAW_CAT_CD <- fct_relevel(df_year_target$LAW_CAT_CD, c('F', 'M', 'V'))

levels(complaint.df_year_target$LAW_CAT_CD) <- c('F', 'M', 'V')
complaint.df_year_target <- complaint.df_year_target[complaint.df_year_target$LAW_CAT_CD != 'I', c('Type', 'Year', 'LAW_CAT_CD', 'count')]
complaint.df_year_target

ca.df_year_target <- rbind(df_year_target, complaint.df_year_target)
ca.df_year_target$CombinedType <- paste(ca.df_year_target$Type, ca.df_year_target$LAW_CAT_CD)
ca.df_year_target <- ca.df_year_target[order(ca.df_year_target$Year),]

```

```{r plot complaint v.s. arrest}

caption = "Number of complaint v.s. arrest incidents of different offense level over years"

interactive_trend_plot_ca <- function(df){
  levels(df$LAW_CAT_CD) <- c("Felony", "Misdemeanor", "Violation")
  plt <-
    df %>% 
      hchart(
        'line', hcaes(x = Year, y = count, group = 'CombinedType')
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>", caption, "</b>")) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

interactive_trend_plot_ca(ca.df_year_target)

```


```{r arrest/complaint percent data transform by year}

ca.df_year_target <-
  ca.df_year_target %>% group_by(LAW_CAT_CD, Year) %>% mutate(percent = count/sum(count))

ca.df_year_target <- ca.df_year_target %>% filter(Type == 'Arrest')

```


```{r arrest/complaint percent plot by year}
caption = "Arrest/complaint Incident percent plot of different offense level over years"
interactive_trend_plot_ca_ratio <- function(df){
  levels(df$LAW_CAT_CD) <- c("Felony", "Misdemeanor", "Violation")
  plt <-
    df %>% 
      hchart(
        'line', hcaes(x = Year, y = percent, group = 'LAW_CAT_CD')
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>", caption, "</b>")) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

interactive_trend_plot_ca_ratio(ca.df_year_target)
ca.df_year_target
```

### NLP Analysis

```{r}
clean_text <- function(docs) {
  # Convert the text to lower case
  docs <- tm_map(docs, content_transformer(tolower))
  # Remove numbers
  docs <- tm_map(docs, removeNumbers)
  # Remove english common stopwords
  docs <- tm_map(docs, removeWords, stopwords("english"))
  # Remove your own stop word
  # specify your stopwords as a character vector
  docs <- tm_map(docs, removeWords, c("related", "blabla2")) 
  # Remove punctuations
  docs <- tm_map(docs, removePunctuation)
  # Eliminate extra white spaces
  docs <- tm_map(docs, stripWhitespace)
  return(docs)
}

generate_word_cloud <- function(docs){
  dtm <- TermDocumentMatrix(docs)
  m <- as.matrix(dtm)
  v <- sort(rowSums(m),decreasing=TRUE)
  d <- data.frame(word = names(v),freq=v)
  
  set.seed(5702)
  wd <- wordcloud(words = d$word, freq = d$freq, min.freq = 1,
            max.words=200, random.order=FALSE, rot.per=0.35, 
            colors=viridis(n = 128))
  return(wd)
}

complaint.df_year_target_nlp <- complaint.df_year_target_nlp %>% filter(Year > 2016)
docs <- Corpus(VectorSource(complaint.df_year_target_nlp$OFNS_DESC))
docs <- clean_text(docs)
wd <- generate_word_cloud(docs)
```



## Hate Crime Analysis

Total Hate Crime Number this year

```{r}
# get map
manhattan_map <- get_map(location = c(lon = -73.95, lat = 40.7), zoom = 11, scale = "auto", )
#ggmap(manhattan_map)

```

```{r, echo=FALSE}
arrests <- read.csv(file = 'data/NYPD_Arrest_Data__Year_to_Date_.csv')
points <- arrests[,c("Latitude","Longitude")]
points <- points[which(!is.na(points$Latitude)),]
points <- points[which(!is.na(points$Longitude)),]


r <- GET('http://data.beta.nyc//dataset/0ff93d2d-90ba-457c-9f7e-39e47bf2ac5f/resource/35dd04fb-81b3-479b-a074-a27a37888ce7/download/d085e2f8d0b54d4590b1e7d1f35594c1pediacitiesnycneighborhoods.geojson')

nyc_neighborhoods <- readOGR(content(r,'text'), 'OGRGeoJSON', verbose = F)

points_spdf <- points
coordinates(points_spdf) <- ~Longitude + Latitude
proj4string(points_spdf) <- proj4string(nyc_neighborhoods)
matches <- over(points_spdf, nyc_neighborhoods)
points <- cbind(points, matches)
points_by_neighborhood <- points %>% group_by(neighborhood) %>% dplyr::summarize(num_points=n())

map_data <- geo_join(nyc_neighborhoods, points_by_neighborhood, "neighborhood", "neighborhood")

plot_data <- tidy(nyc_neighborhoods, region="neighborhood") %>%
  left_join(., points_by_neighborhood, by=c("id"="neighborhood")) %>%
  filter(!is.na(num_points))

```

```{r}
ggmap(manhattan_map)+
  geom_polygon(data=plot_data, aes(x=long, y=lat, group=group, fill=num_points), alpha=0.75) + 
  scale_fill_gradient(low="yellow", high="red") + 
  ggtitle("Figure 1\n\nTotal Crimes per Neighborhood in NYC from 2021") + 
  xlab("") +
  ylab("") + 
  labs(fill="Number of Crimes")
```

```{r}
leaflet(plot_data) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~long, ~lat, radius = 5, stroke=FALSE, fillOpacity = 0.5)
```


