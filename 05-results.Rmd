# Results

```{r echo = FALSE, results = FALSE}
#all the code below are just tests, just trying to make things work , will be extracted later on
library(ff)

library(ggmap)
library(ggplot2)
library(tidyr)
library(highcharter)
library(leaflet)
library(lubridate)

library(rgdal)
library(httr)
library(dplyr)
library(sp)
library(tigris)
library(broom)

require("maptools")
library("gpclib")
gpclibPermit()

library('rjson')
library(ggpubr)

library(RColorBrewer)

result <- fromJSON(file = 'configure.json')
GOOGLE_KEY <- result$GOOGLE_KEY
register_google(key = GOOGLE_KEY)
# ggmap version 2.7+ required, use devtools::install_github('dkahle/ggmap', dep=F)


```


## Crime Arrest Analysis

### Overall Illustration on Map

```{r}
library(leaflet)
library(ggmap)

df_year = df_year %>% mutate(lon = Longitude, lat = Latitude)
df_2020 = df_year %>% filter(Year == "2020")
leaflet(df_year, height=300, width=900) %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=df_2020$lon, lat=df_2020$lat,
             clusterOptions = markerClusterOptions())

```



### Temporal Analysis

We first perform some transformation on the arrest dataset to enable our illustration for the trend of the data.

Then we first could illustrate in the time line to see the trend of the overall incidents for each level of offense to see if there is any dramatic change in the pandameic year.   

```{r illustrate time trend for arrest, total count for offense}
options(scipen = 999)
df_year_target$LAW_CAT_CD <- factor(df_year_target$LAW_CAT_CD, levels = c("M", "F", "V", "I"))

year_range <- unique(df_year_target$Year)
caption = "Number of incidents of different offense level over"
caption <- paste(caption,
                 min(year_range), "-", max(year_range))

cols <- brewer.pal(n = 8, name = "Set2")
color_lst <- colorspace::rainbow_hcl(n = 4)

static_trend_plot_arrest <- function(df) {
  plt_arrest_1 <- 
    ggplot(data = df, aes(x = as.numeric(Year), y = count)) + 
      ggtitle(caption) + 
      xlab("Year") + 
      ylab("Number of incidents") + 
      geom_point(aes(color = LAW_CAT_CD), size = 1) + 
      geom_line(aes(color = LAW_CAT_CD), size = 1) +
      scale_color_manual(labels = c("Misdemeanor", "Felony", "Violation", "Other"), values = color_lst) +
      theme_bw() +
      guides(color = guide_legend("Levels of Offense"))
  
  return(plt_arrest_1)
}


interactive_trend_plot_arrest <- function(df){
  levels(df$LAW_CAT_CD) <- c("Misdemeanor", "Felony", "Violation", "Other")
  plt <-
    df %>% 
      hchart(
        'line', hcaes(x = Year, y = count, group = LAW_CAT_CD)
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>", caption, "</b>")) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

# static_trend_plot_arrest(df_year_target)
interactive_trend_plot_arrest(df_year_target)
```

Also, we could investigate the ratio of each kind of offense by years by looking at the stacked bar plot,   

```{r interactive bar chart 1 for arrest data}
temporal_ratio_plot_arrest <- function(df) {
  levels(df$LAW_CAT_CD) <- c("Misdemeanor", "Felony", "Violation", "Other")
  plt <-
    df %>% 
      hchart(
        'column', hcaes(x = 'Year', y = 'count', group = 'LAW_CAT_CD'),
        stacking = 'normal'
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating = TRUE, y = 50) %>%
      hc_title(text = "<b>Ratio trend of different level of offense event</b>") %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense") 
  return(plt)
}
temporal_ratio_plot_arrest(df_year_target)
```

From the plot, we notice that though over the years since 2016 to 2020, the misdemeanor level of offense remains as the most frequently happened events, its ratio suffers a significant decrease. Moreover, we can witness the improvement in the safety of the community by noticing the fewer and fewer occupation of the violation class events.    



### Spatial Analysis   
Having some basic idea in temporal data, we could then zoom in to investigate the detailed spatial distibution of those offense incidents.  

```{r}
df_year$LAW_CAT_CD <- factor(df_year$LAW_CAT_CD, levels = c("M", "F", "V", "I"))

spatial_plot_arrest <- function(df, year){
  plt_arrest_3 <-
    ggplot(data = df %>% filter(Year == year), aes(x = ARREST_BORO)) + 
        geom_bar(aes(fill = LAW_CAT_CD)) + 
        scale_fill_manual(labels = c("Misdemeanor", "Felony", "Violation", "Other"), values = color_lst) +
        ggtitle(paste("The histogram of offense incidents by borough, Year", year)) + 
        xlab("Areas (Boroughs)") + 
        ylab("Number of offenses")  +
        theme(legend.position = "bottom") + 
        scale_x_discrete(labels = c('Bronx', 'Staten Island', 'Brooklyn', 'Manhattan', 'Queens')) +
        guides(fill = guide_legend("Levels of Offense"))
  return(plt_arrest_3)
}

spatial_plot_arrest_interactive <- function(df, year) {
  levels(df$LAW_CAT_CD) <- c("Misdemeanor", "Felony", "Violation", "Other")
  levels(df$ARREST_BORO) <- c('Bronx', 'Brooklyn', 'Manhattan', 'Queens', 'Staten Island', 'Other')
  plt <- 
    df %>% filter(Year == year) %>%
      hchart(
        'column', hcaes(x = 'ARREST_BORO', y = 'count', group = 'LAW_CAT_CD'),
        stacking = 'normal'
      ) %>%
      hc_colors(cols) %>%
      hc_legend(align = "right", verticalAlign = "top",layout = "horizontal",floating=TRUE, y = 50) %>%
      hc_title(text = paste("<b>The histogram of offense incidents by borough, Year", year, '</b>')) %>%
      hc_subtitle(text = "Click on the legend to hide/show the seleced level of offense")
  return(plt)
}

df <- df_year %>% group_by(Year, LAW_CAT_CD, ARREST_BORO) %>% summarise(count = n()) 

spatial_plot_arrest_interactive(df, 2010)
spatial_plot_arrest_interactive(df, 2019)
spatial_plot_arrest_interactive(df, 2020)

# spatial_plot_arrest(df_year, 2010)
# spatial_plot_arrest(df_year, 2019)
# spatial_plot_arrest(df_year, 2020)

```



## Hate Crime Analysis

Total Hate Crime Number this year

```{r}
# get map
manhattan_map <- get_map(location = c(lon = -73.95, lat = 40.7), zoom = 11, scale = "auto", )
#ggmap(manhattan_map)

```

```{r, echo=FALSE}
arrests <- read.csv(file = 'data/NYPD_Arrest_Data__Year_to_Date_.csv')
points <- arrests[,c("Latitude","Longitude")]
points <- points[which(!is.na(points$Latitude)),]
points <- points[which(!is.na(points$Longitude)),]


r <- GET('http://data.beta.nyc//dataset/0ff93d2d-90ba-457c-9f7e-39e47bf2ac5f/resource/35dd04fb-81b3-479b-a074-a27a37888ce7/download/d085e2f8d0b54d4590b1e7d1f35594c1pediacitiesnycneighborhoods.geojson')

nyc_neighborhoods <- readOGR(content(r,'text'), 'OGRGeoJSON', verbose = F)

points_spdf <- points
coordinates(points_spdf) <- ~Longitude + Latitude
proj4string(points_spdf) <- proj4string(nyc_neighborhoods)
matches <- over(points_spdf, nyc_neighborhoods)
points <- cbind(points, matches)
points_by_neighborhood <- points %>% group_by(neighborhood) %>% dplyr::summarize(num_points=n())

map_data <- geo_join(nyc_neighborhoods, points_by_neighborhood, "neighborhood", "neighborhood")

plot_data <- tidy(nyc_neighborhoods, region="neighborhood") %>%
  left_join(., points_by_neighborhood, by=c("id"="neighborhood")) %>%
  filter(!is.na(num_points))

```

```{r}
ggmap(manhattan_map)+
  geom_polygon(data=plot_data, aes(x=long, y=lat, group=group, fill=num_points), alpha=0.75) + 
  scale_fill_gradient(low="yellow", high="red") + 
  ggtitle("Figure 1\n\nTotal Crimes per Neighborhood in NYC from 2021") + 
  xlab("") +
  ylab("") + 
  labs(fill="Number of Crimes")
```

```{r}
leaflet(plot_data) %>%
  addTiles() %>%
  setView(-74.00, 40.71, zoom = 10) %>%
  addCircleMarkers(~long, ~lat, radius = 5, stroke=FALSE, fillOpacity = 0.5)
```


